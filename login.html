<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil de Talento</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-color: #0077b5;
            --secondary-color: #5e5e5e;
            --light-secondary-color: #86888a;
            --background-gradient-start: #eef2f7;
            --background-gradient-end: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #333;
            --input-border-color: #ced4da;
            --success-color: #008000;
            --info-color: #17a2b8;
            --font-family: 'Poppins', sans-serif;
            --border-radius: 10px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align items to the top */
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
            line-height: 1.6;
        }

        .main-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
        }

        .auth-section, .profile-section, .indications-section, .actions-section {
            background-color: var(--card-background);
            padding: 25px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            text-align: center;
        }

        .auth-section h2, .profile-section h2, .indications-section h2, .actions-section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .linkedin-login-button, .linkedin-logout-button, .action-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-decoration: none;
        }
        .linkedin-login-button {
             width: auto; /* Allow button to size to content */
             min-width: 250px;
             justify-content: center;
        }
        .linkedin-login-button:hover, .linkedin-logout-button:hover, .action-button:hover {
            background-color: #005e8e;
            transform: translateY(-2px);
        }
        .linkedin-logout-button {
            background-color: #d14343;
        }
        .linkedin-logout-button:hover {
            background-color: #b03030;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Align items with space */
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }
        .user-info .user-details {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        .user-info #userName {
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 0.9em;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--input-border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: var(--font-family);
            font-size: 0.95em;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 119, 181, 0.20);
            outline: none;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group .help-text {
            font-size: 0.8em;
            color: var(--light-secondary-color);
            display: block;
            margin-top: 4px;
        }

        .indications-summary {
            background-color: var(--info-color);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        .indications-summary p {
            margin: 5px 0;
            font-size: 1.1em;
        }
        .indications-summary strong {
            font-size: 1.5em;
        }
        .indications-list {
            text-align: left;
            list-style: none;
            padding: 0;
        }
        .indications-list li {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 5px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide sections until login */
        .profile-section, .indications-section, .actions-section, #userInfo, #logoutButton {
            display: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <section id="authSection" class="auth-section">
            <div id="loginArea">
                <h2>Bem-vindo(a) à Nossa Rede de Talentos!</h2>
                <p id="authMessage">Para ver suas indicações e gerenciar seu perfil, por favor, faça login com o LinkedIn.</p>
                <button id="loginButton" class="linkedin-login-button">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="margin-right: 8px;"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"></path></svg>
                    Entrar com LinkedIn
                </button>
            </div>
            <div id="userInfo" class="user-info">
                <div class="user-details">
                    <img id="userAvatar" src="https://placehold.co/50x50/0077b5/FFFFFF?text=LI&font=poppins" alt="Avatar">
                    <span id="userName"></span>
                </div>
                <button id="logoutButton" class="linkedin-logout-button">Sair</button>
            </div>
        </section>

        <section id="indicationsSection" class="indications-section">
            <h2>Suas Indicações</h2>
            <div id="indicationsSummary" class="indications-summary">
                <p>Você recebeu <strong id="indicationsCount">0</strong> indicação(ões).</p>
            </div>
            <p>Áreas em que você foi indicado(a):</p>
            <ul id="indicatedAreasList" class="indications-list">
                <li id="noIndicationsMessage">Faça login para ver suas indicações.</li>
            </ul>
        </section>

        <section id="profileSection" class="profile-section">
            <h2>Complete Seu Perfil de Talento</h2>
            <p>Informações adicionais nos ajudam a encontrar as melhores oportunidades para você!</p>
            <form id="profileForm">
                <div class="form-group">
                    <label for="current_salary">Salário Atual (R$, opcional):</label>
                    <input type="number" id="current_salary" name="current_salary" placeholder="Ex: 5000">
                </div>
                <div class="form-group">
                    <label for="desired_salary">Salário Desejado (R$, opcional):</label>
                    <input type="number" id="desired_salary" name="desired_salary" placeholder="Ex: 7000">
                </div>
                <div class="form-group">
                    <label for="skills">Suas Principais Habilidades:</label>
                    <textarea id="skills" name="skills" placeholder="Ex: JavaScript, React, Gestão de Projetos, Liderança"></textarea>
                    <span class="help-text">Separe as habilidades por vírgula.</span>
                </div>
                <div class="form-group">
                    <label for="desired_role_type">Tipo de Posição / Área de Atuação Desejada:</label>
                    <input type="text" id="desired_role_type" name="desired_role_type" placeholder="Ex: Desenvolvedor Front-end Sênior, Gerente de Marketing Digital">
                </div>
                <div class="form-group">
                    <label for="desired_companies">Empresas dos Sonhos (opcional):</label>
                    <textarea id="desired_companies" name="desired_companies" placeholder="Ex: Google, Nubank, Empresa X"></textarea>
                    <span class="help-text">Separe os nomes das empresas por vírgula.</span>
                </div>
                <button type="submit" class="action-button">Salvar Informações do Perfil</button>
            </form>
        </section>

        <section id="actionsSection" class="actions-section">
             <h2>Indique Outros Talentos</h2>
             <p>Conhece mais pessoas incríveis? Ajude a nossa rede a crescer!</p>
             <a href="index.html" class="action-button">Fazer uma Nova Indicação</a>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'https://kyeyxkzvvxcypyjsfuzu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5ZXl4a3p2dnhjeXB5anNmdXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcxNDczNzAsImV4cCI6MjA2MjcyMzM3MH0.H3ZS35V1vxU9TLRAzi10kOiFdZcZtKlAX9bJ0DVKrAc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const loginAreaDiv = document.getElementById('loginArea');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userAvatarImg = document.getElementById('userAvatar');

        const profileSection = document.getElementById('profileSection');
        const indicationsSection = document.getElementById('indicationsSection');
        const actionsSection = document.getElementById('actionsSection');
        const profileForm = document.getElementById('profileForm');

        const indicationsCountSpan = document.getElementById('indicationsCount');
        const indicatedAreasListUl = document.getElementById('indicatedAreasList');
        const noIndicationsMessageLi = document.getElementById('noIndicationsMessage');

        let currentUser = null;

        async function fetchUserIndications(user) {
            if (!user || !user.user_metadata?.full_name) {
                indicationsCountSpan.textContent = '0';
                indicatedAreasListUl.innerHTML = '<li>Não foi possível verificar seu nome para buscar indicações.</li>';
                return;
            }

            const userNameFromLinkedIn = user.user_metadata.full_name;
            // Tentativa de buscar pelo nome completo. Idealmente, seria por um ID único do LinkedIn.
            // Esta é uma simplificação e pode não ser 100% precisa.
            const { data: indications, error: indicationsError } = await supabaseClient
                .from('indicacoes') // Sua tabela de indicações
                .select('areas_destaque, linkedin_indicado') // Seleciona as áreas e o link do indicado
                // .eq('linkedin_indicado', userLinkedInProfileUrl) // Forma ideal se tivéssemos a URL canônica
                .ilike('nome_indicado', `%${userNameFromLinkedIn}%`); // Busca aproximada pelo nome

            if (indicationsError) {
                console.error('Erro ao buscar indicações:', indicationsError);
                indicationsCountSpan.textContent = 'Erro';
                indicatedAreasListUl.innerHTML = '<li>Não foi possível carregar as áreas indicadas.</li>';
            } else if (indications && indications.length > 0) {
                indicationsCountSpan.textContent = indications.length;
                const allAreas = indications.flatMap(ind => ind.areas_destaque || []);
                const uniqueAreas = [...new Set(allAreas.filter(area => area))];

                if (uniqueAreas.length > 0) {
                    noIndicationsMessageLi.style.display = 'none';
                    indicatedAreasListUl.innerHTML = uniqueAreas.map(area => `<li>${area}</li>`).join('');
                } else {
                    noIndicationsMessageLi.textContent = 'Você foi indicado(a), mas sem áreas específicas mencionadas.';
                    noIndicationsMessageLi.style.display = 'list-item';
                    indicatedAreasListUl.innerHTML = '';
                    indicatedAreasListUl.appendChild(noIndicationsMessageLi);
                }
            } else {
                indicationsCountSpan.textContent = '0';
                noIndicationsMessageLi.textContent = 'Nenhuma indicação encontrada para seu nome no momento.';
                noIndicationsMessageLi.style.display = 'list-item';
                indicatedAreasListUl.innerHTML = '';
                indicatedAreasListUl.appendChild(noIndicationsMessageLi);
            }
        }

        async function loadOrCreateUserProfile(user) {
            const { data: profile, error } = await supabaseClient
                .from('user_profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116: no rows found
                console.error('Erro ao buscar perfil do usuário:', error);
                return null;
            }

            if (profile) {
                populateProfileForm(profile);
                return profile;
            } else {
                // Perfil não existe, vamos criar um básico com os dados do LinkedIn
                const linkedInIdentity = user.identities?.find(id => id.provider === 'linkedin');
                const newProfileData = {
                    id: user.id,
                    full_name: user.user_metadata?.full_name || user.email,
                    email: user.email,
                    avatar_url: user.user_metadata?.avatar_url,
                    linkedin_user_id: linkedInIdentity?.id // ID específico do LinkedIn
                    // linkedin_profile_url: // Idealmente obtido via Edge Function
                };
                const { data: createdProfile, error: createError } = await supabaseClient
                    .from('user_profiles')
                    .insert(newProfileData)
                    .select()
                    .single();

                if (createError) {
                    console.error("Erro ao criar perfil inicial:", createError);
                    return null;
                }
                console.log("Perfil inicial criado:", createdProfile);
                populateProfileForm(createdProfile);
                return createdProfile;
            }
        }

        function populateProfileForm(profile) {
            if (!profile || !profileForm) return;
            profileForm.elements.current_salary.value = profile.current_salary || '';
            profileForm.elements.desired_salary.value = profile.desired_salary || '';
            profileForm.elements.skills.value = (profile.skills || []).join(', ');
            profileForm.elements.desired_role_type.value = profile.desired_role_type || '';
            profileForm.elements.desired_companies.value = (profile.desired_companies || []).join(', ');
        }

        // Atualiza a UI e carrega dados quando o usuário loga/desloga
        async function handleAuthStateChange(user) {
            currentUser = user;
            if (user) {
                loginAreaDiv.style.display = 'none';
                userInfoDiv.style.display = 'flex';
                logoutButton.style.display = 'inline-flex';
                userNameSpan.textContent = user.user_metadata?.full_name || user.email;
                userAvatarImg.src = user.user_metadata?.avatar_url || 'https://placehold.co/50x50/0077b5/FFFFFF?text=LI&font=poppins';

                profileSection.style.display = 'block';
                indicationsSection.style.display = 'block';
                actionsSection.style.display = 'block';

                await loadOrCreateUserProfile(user);
                await fetchUserIndications(user);

            } else {
                loginAreaDiv.style.display = 'block';
                userInfoDiv.style.display = 'none';
                logoutButton.style.display = 'none';
                profileSection.style.display = 'none';
                indicationsSection.style.display = 'none';
                actionsSection.style.display = 'none';
                indicationsCountSpan.textContent = '0';
                indicatedAreasListUl.innerHTML = '<li id="noIndicationsMessage">Faça login para ver suas indicações.</li>';
                if(profileForm) profileForm.reset();
            }
        }

        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth Event:', event, 'Session:', session);
            handleAuthStateChange(session ? session.user : null);
        });

        if (loginButton) {
            loginButton.addEventListener('click', async () => {
                const { error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'linkedin_oidc', // CORRIGIDO: Usar 'linkedin_oidc'
                    options: {
                        redirectTo: window.location.href,
                        scopes: 'profile openid email r_liteprofile'
                    }
                });
                if (error) console.error('Erro ao iniciar login com LinkedIn:', error);
            });
        }

        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                const { error } = await supabaseClient.auth.signOut();
                if (error) console.error('Erro no logout:', error);
            });
        }

        if (profileForm) {
            profileForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!currentUser) {
                    alert("Você precisa estar logado para salvar o perfil.");
                    return;
                }

                const submitProfileButton = profileForm.querySelector('button[type="submit"]');
                const originalButtonText = submitProfileButton.textContent;
                submitProfileButton.disabled = true;
                submitProfileButton.innerHTML = 'Salvando... <span class="spinner"></span>';

                const profileDataToSave = {
                    id: currentUser.id, // Chave primária
                    current_salary: profileForm.elements.current_salary.value ? parseFloat(profileForm.elements.current_salary.value) : null,
                    desired_salary: profileForm.elements.desired_salary.value ? parseFloat(profileForm.elements.desired_salary.value) : null,
                    skills: profileForm.elements.skills.value.split(',').map(s => s.trim()).filter(s => s.length > 0),
                    desired_role_type: profileForm.elements.desired_role_type.value.trim() || null,
                    desired_companies: profileForm.elements.desired_companies.value.split(',').map(s => s.trim()).filter(s => s.length > 0),
                    updated_at: new Date().toISOString(),
                    // Manter dados obtidos do LinkedIn se já existirem
                    full_name: currentUser.user_metadata?.full_name || currentUser.email,
                    email: currentUser.email,
                    avatar_url: currentUser.user_metadata?.avatar_url,
                    linkedin_user_id: currentUser.identities?.find(id => id.provider === 'linkedin')?.id || null
                };

                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .upsert(profileDataToSave, { onConflict: 'id' })
                    .select()
                    .single();

                if (error) {
                    console.error('Erro ao salvar perfil:', error);
                    alert(`Erro ao salvar perfil: ${error.message}`);
                } else {
                    console.log('Perfil salvo:', data);
                    alert('Perfil salvo com sucesso!');
                }
                submitProfileButton.disabled = false;
                submitProfileButton.textContent = originalButtonText;
            });
        }

        // Lógica para o botão "Indicar Outro Talento" na página de agradecimento da outra página (não aplicável aqui diretamente)
        // Mas o link para indicar está no HTML acima.

    </script>
</body>
</html>
